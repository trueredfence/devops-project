name: ${COMPOSE_PROJECT_NAME}

volumes:
  redfence_storage:
    name: ${COMPOSE_PROJECT_NAME}_storage
  postgres_data:
    name: ${COMPOSE_PROJECT_NAME}_db_data

networks:
  gateway-net:
    external: true
    name: redfence-gateway-net
  internal-net:
    driver: bridge

services:
  # --- DATABASE ---
  postgres:
    container_name: ${COMPOSE_PROJECT_NAME}-db
    image: postgres:15-alpine
    restart: unless-stopped
    env_file: .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal-net
      - gateway-net # access via pgadmin
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      # test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  
  # --- MIGRATION RUNNER ---
  migrate:
    # container_name: ${COMPOSE_PROJECT_NAME}-migrate
    build:
      context: .
      dockerfile: ./config/nextjs/Dockerfile
      target: migration_runner
    image: redfence/migrate:${APP_TAG}
    env_file: .env
    networks: ["internal-net"]
    profiles: ["tools"]
    # command: npx drizzle-kit migrate
    command: >
      sh -c "npx drizzle-kit migrate && npm run db:seed"
    restart: no

  # --- CACHE ---
  redis:
    # container_name: ${COMPOSE_PROJECT_NAME}-redis
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - internal-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s

  # --- NEXT.JS APPLICATION ---
  app:
    # container_name: ${COMPOSE_PROJECT_NAME}-app
    build:
      context: .
      dockerfile: ./config/nextjs/Dockerfile
      target: runner
    deploy:
      update_config:
        order: start-first           # THE SECRET: Start new container before stopping old
        failure_action: rollback    # If new one fails, keep the old one running
        delay: 5s
    image: redfence/app:${APP_TAG}
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    env_file: .env
    volumes:
      - "redfence_storage:/app/public/reports"
    networks:
      internal-net:
      gateway-net:
        # --- HIGHLIGHTED CHANGE ---
        # This alias must match the name used in your Nginx 'set $upstream' variable
        aliases:
          - ${COMPOSE_PROJECT_NAME}-app
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/ || exit 1"]
      interval: 10s
      start_period: 40s

  # --- GLOBAL GATEWAY (Run once) ---
  nginx:
    container_name: nginx-global
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./config/nginx/conf.d:/etc/nginx/conf.d:ro"
      - "./config/cert:/etc/letsencrypt:ro"
      - "${PROD_STORAGE_VOL:-redfence_storage}:/app/prod-reports:ro"
      - "${UAT_STORAGE_VOL:-redfence_storage}:/app/uat-reports:ro"
    networks:
      - gateway-net
    profiles: ["gateway"]

  # --- GLOBAL DB MGMT ---
  pgadmin:
    container_name: pgadmin-global
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    env_file: .env
    networks:
      - gateway-net
      - internal-net
    profiles: ["gateway"]

  # --- CLOUDFLARE TUNNEL ---
  # tunnel:
  #   image: cloudflare/cloudflared:latest
  #   container_name: ${COMPOSE_PROJECT_NAME}-tunnel
  #   restart: unless-stopped
  #   env_file: .env
  #   command: tunnel --no-autoupdate run
  #   networks:
  #     - gateway-net
  #   depends_on:
  #     - nginx