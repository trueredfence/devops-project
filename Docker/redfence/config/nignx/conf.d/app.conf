# /etc/nginx/conf.d/app.conf

# 1. Map environments to upstream names
upstream prod_backend { server prod-redfence-app:3000; keepalive 32; }
upstream uat_backend { server uat-redfence-app:3000; keepalive 32; }

# 2. Redirect HTTP to HTTPS
server {
    listen 80;
    server_name redfence.bytesec.co.in uat-redfence.bytesec.co.in;
    return 301 https://$host$request_uri;
}

# 3. Main Server Block
server {
    listen 443 ssl http2;
    server_name redfence.bytesec.co.in uat-redfence.bytesec.co.in;

    ssl_certificate /etc/letsencrypt/bytesec.co.in.pem;
    ssl_certificate_key /etc/letsencrypt/bytesec.co.in.key;

    # Use Docker's internal DNS
    resolver 127.0.0.11 valid=30s;
    include /etc/nginx/conf.d/snippets/cloudflare-realip.conf;

    # Logic to pick upstream based on domain
    set $upstream_app "prod_backend";
    if ($host = "uat-redfence.bytesec.co.in") {
        set $upstream_app "uat_backend";
    }

    # --- Routes ---

    # Auth: Very strict
    location ~ ^/(login|signup|auth) {
        limit_req zone=auth_limit burst=5 nodelay;
        limit_req_status 429;
        include /etc/nginx/conf.d/snippets/common-proxy.conf;
        proxy_pass http://$upstream_app;
    }

    # API: Medium strict
    location /api/ {
        limit_req zone=api_limit burst=10 nodelay;
        limit_req_status 429;
        include /etc/nginx/conf.d/snippets/common-proxy.conf;
        proxy_pass http://$upstream_app;
    }

    # Static Assets: No rate limit, high cache
    location /_next/static/ {
        alias /app/public/.next/static/; # If using volumes for speed
        expires 365d;
        access_log off;
    }

    # pgAdmin only in UAT
    location /pgadmin/ {
        set $pgadmin_url "http://pgadmin:80";
        proxy_set_header X-Script-Name /pgadmin;
        include /etc/nginx/conf.d/snippets/common-proxy.conf;
        proxy_pass $pgadmin_url;
    }

    # Default
    location / {
        limit_req zone=general_limit burst=20 nodelay;
        include /etc/nginx/conf.d/snippets/common-proxy.conf;
        proxy_pass http://$upstream_app;
    }
}